<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…Ø­Ù„Ù„ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠ - Ø§Ù„Ø¹Ù‚ÙŠÙ‚</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js"></script>
    <style>
        :root { --primary-blue: #004a99; }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background: #eceff1; }
        
        /* === Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØµÙØ­Ø© (Ù„Ù„Ø¹Ø±Ø¶ Ø¹Ù„Ù‰ Ø§Ù„Ø´Ø§Ø´Ø©) === */
        .printable-page { 
            background: white; 
            width: 210mm; 
            min-height: 297mm; 
            margin: 10px auto; 
            padding: 20px 25px; 
            border: 1px solid #000; 
            position: relative; 
            box-sizing: border-box;
        }
        
        /* === Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ØµØ§Ø±Ù…Ø© (Ù„Ø­Ù„ Ù…Ø´ÙƒÙ„Ø© Ø§Ù„ØµÙØ­Ø§Øª Ø§Ù„ÙØ§Ø±ØºØ©) === */
        @media print {
            @page { margin: 5mm; size: auto; } /* Ù‡ÙˆØ§Ù…Ø´ ØµØºÙŠØ±Ø© Ù„Ù„Ø·Ø§Ø¨Ø¹Ø© */
            body { margin: 0; background: white; height: auto; }
            .printable-page { 
                margin: 0; 
                border: none; 
                width: 100%; 
                min-height: auto; /* Ù…Ù‡Ù… Ø¬Ø¯Ø§Ù‹: Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø§Ø±ØªÙØ§Ø¹ Ø§Ù„Ø«Ø§Ø¨Øª */
                height: auto; 
                box-shadow: none; 
                padding: 0;
            }
            .no-print, .user-credit, #dlBtn, .delete-col, .plan-select { display: none !important; }
            .action-textarea { border: none; resize: none; overflow: hidden; }
            .sig-input { border: none; }
            td.delete-col, th.delete-col { display: none; }
            thead { display: table-header-group; }
            
            /* Ø¥Ø¬Ø¨Ø§Ø± Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ ØµÙØ­Ø§Øª ÙØ§Ø±ØºØ© */
            html, body { height: auto; overflow: visible; }
            * { page-break-after: auto; }
        }

        /* ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø§Ù„Ø¹Ù†Ø§ØµØ± */
        .clean-select {
            appearance: none; -webkit-appearance: none; -moz-appearance: none;
            background: transparent !important; border: none;
            padding: 0; margin: 0; font-weight: bold; font-size: inherit;
            color: #000; cursor: pointer; width: auto; text-align: right;
        }
        .clean-select:focus { outline: none; }

        .header-table { width: 100%; border: 2px solid var(--primary-blue); margin-bottom: 5px; direction: rtl; }
        .header-table td { border: 1px solid var(--primary-blue); padding: 5px; text-align: center; vertical-align: middle; font-size: 13px; }
        
        .report-main-title { font-size: 18px; font-weight: bold; text-align: center; margin: 10px 0; border: 2px solid #000; padding: 6px; background: #f5f5f5; }
        .plan-main-title { width: 100%; border: none; font-size: 16px; font-weight: bold; text-align: center; background: #e8f5e9; padding: 5px; margin-bottom: 5px; text-decoration: underline; margin-top: 10px;}

        .main-table { width: 100%; border-collapse: collapse; margin-top: 5px; table-layout: fixed; }
        .main-table th, .main-table td { border: 1px solid #000; padding: 3px; text-align: center; font-size: 12px; vertical-align: middle; }
        .main-table th { background: #f2f2f2; }
        
        .btn-delete { color: #dc3545; cursor: pointer; border: none; background: transparent; font-size: 16px; font-weight: bold; line-height: 1; }
        .stats-row { display: flex; justify-content: space-around; border: 1px solid #000; padding: 5px; font-weight: bold; background: #fafafa; margin-bottom: 5px; font-size: 13px; }
        .no-print { padding: 15px; background: #fff; border-bottom: 3px solid var(--primary-blue); position: sticky; top: 0; z-index: 1000; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .user-credit { color: #ccc; font-size: 10px; text-align: center; margin: 5px; }

        .plan-section { margin-top: 10px; border: 1px solid #000; page-break-inside: avoid; }
        .plan-header { color: white; padding: 5px; font-weight: bold; text-align: right; padding-right: 10px; font-size: 13px; }
        .plan-body { padding: 8px; font-size: 12px; }
        .student-list-box { border: 1px dashed #ccc; padding: 5px; min-height: 25px; background: #fdfdfd; margin-bottom: 8px; line-height: 1.6; text-align: justify; page-break-inside: auto; }
        .action-textarea { width: 100%; border: 1px solid #ddd; font-family: inherit; font-size: 12px; min-height: 40px; background: #fff; padding: 5px; }
        .plan-select { width: 100%; font-size: 11px; margin-bottom: 5px; padding: 3px; border: 1px solid var(--primary-blue); color: var(--primary-blue); background: #f0f8ff; }
        
        .remedial-header { background-color: #dc3545 !important; } 
        .average-header { background-color: #0d6efd !important; } 
        .enrichment-header { background-color: #198754 !important; } 

        .signatures-box { display: flex; justify-content: space-between; text-align: center; margin-top: 30px; font-size: 12px; font-weight: bold; page-break-inside: avoid; }
        .sig-col { flex: 1; padding: 0 5px; }
        .sig-input { border: none; text-align: center; width: 100%; background: transparent; margin-top: 5px; font-weight: normal; }

        /* Ø§Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø§Ù„Ù‡ÙŠÙƒÙ„ Ù„Ù„Ø·Ø¨Ø§Ø¹Ø© */
        .print-layout-table { width: 100%; border: none; border-collapse: collapse; }
        .print-layout-table thead { display: table-header-group; }
        .print-layout-table tbody { display: table-row-group; }
        .print-layout-table td { border: none; padding: 0; }

        .page-break-divider { display: none; }
        .signature-analysis { display: none; } 
        
        /* ÙˆØ¶Ø¹ Ø§Ù„ÙØµÙ„: Ø¥Ø¶Ø§ÙØ© ÙØ§ØµÙ„ ØµÙØ­Ø© ØµØ±ÙŠØ­ */
        .mode-separate .page-break-divider { 
            display: block; 
            page-break-before: always; /* Ù‡Ø°Ø§ Ù‡Ùˆ Ø§Ù„Ø£Ù…Ø± Ø§Ù„ÙˆØ­ÙŠØ¯ Ø§Ù„Ø°ÙŠ ÙŠÙØªØ­ ØµÙØ­Ø© Ø¬Ø¯ÙŠØ¯Ø© */
            height: 0; margin: 0; overflow: hidden;
        }
        .mode-separate .signature-analysis { display: flex; margin-bottom: 0; padding-top: 10px; }
        .mode-merged .only-separate { display: none; }

        canvas { max-height: 130px; width: 100% !important; }
        .noborder { border: none; text-align: center; background: transparent; width: 100%; font-weight: bold; }
        .add-student-section { background: #e3f2fd; border: 2px dashed var(--primary-blue); padding: 8px; border-radius: 10px; }
    </style>
</head>
<body>

<div class="no-print container-fluid">
    <div class="row g-3 align-items-center">
        <div class="col-md-12">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <h6 class="text-primary fw-bold m-0">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</h6>
                <div class="btn-group btn-group-sm" role="group">
                    <input type="radio" class="btn-check" name="layoutMode" id="modeMerged" autocomplete="off" checked onchange="toggleLayout('merged')">
                    <label class="btn btn-outline-primary" for="modeMerged">ğŸ“„ Ø¯Ù…Ø¬ (ØµÙØ­Ø© ÙˆØ§Ø­Ø¯Ø©)</label>
                  
                    <input type="radio" class="btn-check" name="layoutMode" id="modeSep" autocomplete="off" onchange="toggleLayout('separate')">
                    <label class="btn btn-outline-primary" for="modeSep">ğŸ“‘ ÙØµÙ„ Ø§Ù„Ø®Ø·Ø· (ØµÙØ­Ø© Ù…Ø³ØªÙ‚Ù„Ø©)</label>
                </div>
            </div>

            <div class="row g-2 bg-light p-2 rounded border">
                <div class="col-md-2">
                    <select id="examType" class="form-select form-select-sm" onchange="toggleManual(this, 'mExam')">
                        <option>Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰</option><option>Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ø«Ø§Ù†ÙŠØ©</option><option>Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ</option><option>ØªØ´Ø®ÙŠØµÙŠ</option><option value="custom">ÙŠØ¯ÙˆÙŠ...</option>
                    </select>
                    <input type="text" id="mExam" class="form-control form-control-sm mt-1" style="display:none" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±">
                </div>
                <div class="col-md-2">
                    <select id="subject" class="form-select form-select-sm" onchange="toggleManual(this, 'mSub')">
                        <option>Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª</option><option>Ø§Ù„Ø¹Ù„ÙˆÙ…</option><option>Ù„ØºØªÙŠ</option><option>Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©</option><option value="custom">ÙŠØ¯ÙˆÙŠ...</option>
                    </select>
                    <input type="text" id="mSub" class="form-control form-control-sm mt-1" style="display:none" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ø¯Ø©">
                </div>
                <div class="col-md-2">
                    <select id="classGrade" class="form-select form-select-sm" onchange="toggleManual(this, 'mClass')">
                        <option selected>Ø§Ù„Ø«Ø§Ù†ÙŠ Ø§Ù„Ù…ØªÙˆØ³Ø· Ù¡</option><option>Ø§Ù„Ø«Ø§Ù†ÙŠ Ø§Ù„Ù…ØªÙˆØ³Ø· Ù¢</option><option value="custom">ÙŠØ¯ÙˆÙŠ...</option>
                    </select>
                    <input type="text" id="mClass" class="form-control form-control-sm mt-1" style="display:none" placeholder="Ø§Ø³Ù… Ø§Ù„ÙØµÙ„">
                </div>
                <div class="col-md-1">
                    <input type="number" id="totalInClass" class="form-control form-control-sm" value="25" placeholder="Ø§Ù„Ø¹Ø¯Ø¯" oninput="updateAll()">
                </div>
                <div class="col-md-1">
                    <input type="number" id="maxGrade" class="form-control form-control-sm" value="20" placeholder="Ø¯Ø±Ø¬Ø©" oninput="updateAll()">
                </div>
                
                <div class="col-md-4 d-flex gap-2 align-items-end">
                    <button onclick="document.getElementById('excelFile').click()" class="btn btn-success btn-sm w-100">ğŸ“¥ Ø§Ø³ØªÙŠØ±Ø§Ø¯</button>
                    <input type="file" id="excelFile" class="d-none">
                    <button onclick="window.print()" class="btn btn-primary btn-sm w-100">ğŸ–¨ Ø·Ø¨Ø§Ø¹Ø©</button>
                    <button onclick="exportToPDF()" class="btn btn-outline-danger btn-sm w-100">PDF</button>
                </div>
            </div>

            <div class="row mt-2 g-2">
                <div class="col-md-4">
                     <div class="input-group input-group-sm">
                        <span class="input-group-text">Ø¥Ø¶Ø§ÙØ© Ø·Ø§Ù„Ø¨</span>
                        <input type="text" id="manualName" class="form-control" placeholder="Ø§Ù„Ø§Ø³Ù…">
                        <input type="number" id="manualGrade" class="form-control" placeholder="Ø§Ù„Ø¯Ø±Ø¬Ø©" style="max-width: 70px;">
                        <button class="btn btn-dark" onclick="addManual()">+</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="capture" class="printable-page mode-merged">
    
    <div id="analysisContent">
        <table class="header-table">
            <tr>
                <td width="30%">
                    <strong>ÙˆØ²Ø§Ø±Ø© Ø§Ù„ØªØ¹Ù„ÙŠÙ…</strong><br>
                    Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ø§Ù…Ø© Ù„Ù„ØªØ¹Ù„ÙŠÙ… Ø¨Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© Ø§Ù„Ù…Ù†ÙˆØ±Ø©<br>
                    <strong>Ù…Ø¯Ø§Ø±Ø³ Ø§Ù„Ø¹Ù‚ÙŠÙ‚ Ø§Ù„Ø£Ù‡Ù„ÙŠØ©</strong>
                </td>
                <td width="40%">
                    <div class="d-flex justify-content-center gap-2">
                        <img src="https://raw.githubusercontent.com/alhejaili9/Results-Analyst/main/ministry-logo.png" height="50">
                        <img src="https://raw.githubusercontent.com/alhejaili9/Results-Analyst/main/aqeeq_logo.png" height="50">
                    </div>
                </td>
                <td width="30%" class="text-end" style="line-height: 1.8;">
                    <div>Ø§Ù„Ø¹Ø§Ù… Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ: <select id="yearSelect" class="clean-select" onchange="updateAll()"></select></div>
                    <div>Ø§Ù„ÙØµÙ„ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ: <select class="clean-select"><option>Ø§Ù„Ø£ÙˆÙ„</option><option>Ø§Ù„Ø«Ø§Ù†ÙŠ</option><option>Ø§Ù„Ø«Ø§Ù„Ø«</option></select></div>
                    <div>Ø§Ù„Ù…Ø§Ø¯Ø©: <span id="dispSub">-</span></div>
                </td>
            </tr>
        </table>

        <div class="report-main-title" id="reportTitle">ØªØ­Ù„ÙŠÙ„ Ø¯Ø±Ø¬Ø§Øª Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±</div>

        <div class="stats-row">
            <div>Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø§Ø¨: <span id="stTotal">-</span></div>
            <div>Ø­Ø¶ÙˆØ±: <span id="stPresent">-</span></div>
            <div>ØºÙŠØ§Ø¨: <span id="stAbsent">-</span></div>
            <div>Ø§Ù„Ù…ØªÙˆØ³Ø·: <span id="avgVal">-</span></div>
            <div>Ø§Ù„Ù†Ø¬Ø§Ø­: <span id="passRate">-</span></div>
        </div>

        <div class="row mt-2 g-1">
            <div class="col-4 border text-center p-1"><canvas id="pieChart"></canvas></div>
            <div class="col-4 border text-center p-1"><canvas id="barChart"></canvas></div>
            <div class="col-4 border text-center p-1"><canvas id="normalChart"></canvas></div>
        </div>

        <table class="main-table mt-2">
            <thead>
                <tr>
                    <th width="40px">Ù…</th>
                    <th>Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨</th>
                    <th width="60px">Ø§Ù„Ø¯Ø±Ø¬Ø©</th>
                    <th width="80px">Ø§Ù„ØªÙ‚Ø¯ÙŠØ±</th>
                    <th width="40px" class="delete-col no-print">Ø­Ø°Ù</th>
                </tr>
            </thead>
            <tbody id="dataTable"></tbody>
        </table>

        <div class="signature-analysis signatures-box">
            <div class="sig-col">Ù…Ø¹Ù„Ù… Ø§Ù„Ù…Ø§Ø¯Ø©<br><input type="text" class="sig-input" value="Ø¹Ø¨Ø¯Ø§Ù„Ø±Ø­Ù…Ù† Ø³Ø¹Ø¯ Ø§Ù„Ø­Ø¬ÙŠÙ„ÙŠ"></div>
            <div class="sig-col">Ø§Ù„Ù…Ø´Ø±Ù Ø§Ù„Ø£ÙƒØ§Ø¯ÙŠÙ…ÙŠ<br><input type="text" class="sig-input" placeholder="Ø§Ù„Ø§Ø³Ù… Ù‡Ù†Ø§..."></div>
            <div class="sig-col">ÙˆÙƒÙŠÙ„ Ø§Ù„Ù…Ø¯Ø±Ø³Ø©<br><input type="text" class="sig-input" placeholder="Ø§Ù„Ø§Ø³Ù… Ù‡Ù†Ø§..."></div>
            <div class="sig-col">Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ø¯Ø±Ø³Ø©<br><input type="text" class="sig-input" placeholder="Ø§Ù„Ø§Ø³Ù… Ù‡Ù†Ø§..."></div>
        </div>
    </div>

    <div class="page-break-divider"></div>

    <table class="print-layout-table" id="plansTable">
        <thead class="only-separate">
            <tr>
                <td>
                    <div id="plansHeaderCopy" style="margin-bottom: 20px;"></div>
                </td>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td>
                    <div id="plansContainer" class="plans-container">
                        <input type="text" id="autoPlanTitle" class="plan-main-title" value="Ø§Ù„Ø®Ø·Ø· Ø§Ù„Ø¹Ù„Ø§Ø¬ÙŠØ© ÙˆØ§Ù„Ø¥Ø«Ø±Ø§Ø¦ÙŠØ©">

                        <div class="plan-section">
                            <div class="plan-header remedial-header">Ø£ÙˆÙ„Ø§Ù‹: Ø§Ù„Ø®Ø·Ø© Ø§Ù„Ø¹Ù„Ø§Ø¬ÙŠØ© (Ù„Ù„Ù…ØªØ¹Ø«Ø±ÙŠÙ† - Ø£Ù‚Ù„ Ù…Ù† 60%)</div>
                            <div class="plan-body">
                                <strong>Ø§Ù„Ø·Ù„Ø§Ø¨ Ø§Ù„Ù…Ø³ØªÙ‡Ø¯ÙÙˆÙ†:</strong>
                                <div id="remedialNames" class="student-list-box text-danger small"></div>
                                <strong>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª:</strong>
                                <select id="selRemedial" class="form-select plan-select" onchange="appendStrategy('rem', this.value)"><option value="">-- Ø§Ø®ØªØ± Ø®Ø·Ø© --</option></select>
                                <textarea id="txtRemedial" class="action-textarea"></textarea>
                            </div>
                        </div>

                        <div class="plan-section">
                            <div class="plan-header average-header">Ø«Ø§Ù†ÙŠØ§Ù‹: Ø®Ø·Ø© ØªØ­Ø³ÙŠÙ† Ø§Ù„Ù…Ø³ØªÙˆÙ‰ (Ù„Ù„Ù…ØªÙˆØ³Ø·ÙŠÙ† - 60% Ø¥Ù„Ù‰ 90%)</div>
                            <div class="plan-body">
                                <strong>Ø§Ù„Ø·Ù„Ø§Ø¨ Ø§Ù„Ù…Ø³ØªÙ‡Ø¯ÙÙˆÙ†:</strong>
                                <div id="averageNames" class="student-list-box text-primary small"></div>
                                <strong>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª:</strong>
                                <select id="selAverage" class="form-select plan-select" onchange="appendStrategy('avg', this.value)"><option value="">-- Ø§Ø®ØªØ± Ø®Ø·Ø© --</option></select>
                                <textarea id="txtAverage" class="action-textarea"></textarea>
                            </div>
                        </div>

                        <div class="plan-section">
                            <div class="plan-header enrichment-header">Ø«Ø§Ù„Ø«Ø§Ù‹: Ø§Ù„Ø®Ø·Ø© Ø§Ù„Ø¥Ø«Ø±Ø§Ø¦ÙŠØ© (Ù„Ù„Ù…ØªÙÙˆÙ‚ÙŠÙ† - 90% ÙØ£ÙƒØ«Ø±)</div>
                            <div class="plan-body">
                                <strong>Ø§Ù„Ø·Ù„Ø§Ø¨ Ø§Ù„Ù…Ø³ØªÙ‡Ø¯ÙÙˆÙ†:</strong>
                                <div id="enrichmentNames" class="student-list-box text-success small"></div>
                                <strong>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª:</strong>
                                <select id="selEnrichment" class="form-select plan-select" onchange="appendStrategy('enr', this.value)"><option value="">-- Ø§Ø®ØªØ± Ø®Ø·Ø© --</option></select>
                                <textarea id="txtEnrichment" class="action-textarea"></textarea>
                            </div>
                        </div>
                        
                        <div class="signatures-box">
                            <div class="sig-col">Ù…Ø¹Ù„Ù… Ø§Ù„Ù…Ø§Ø¯Ø©<br><input type="text" class="sig-input" id="sigTeacher" value="Ø¹Ø¨Ø¯Ø§Ù„Ø±Ø­Ù…Ù† Ø³Ø¹Ø¯ Ø§Ù„Ø­Ø¬ÙŠÙ„ÙŠ" oninput="syncSigs(this, 0)"></div>
                            <div class="sig-col">Ø§Ù„Ù…Ø´Ø±Ù Ø§Ù„Ø£ÙƒØ§Ø¯ÙŠÙ…ÙŠ<br><input type="text" class="sig-input" id="sigSuper" placeholder="Ø§Ù„Ø§Ø³Ù… Ù‡Ù†Ø§..." oninput="syncSigs(this, 1)"></div>
                            <div class="sig-col">ÙˆÙƒÙŠÙ„ Ø§Ù„Ù…Ø¯Ø±Ø³Ø©<br><input type="text" class="sig-input" id="sigVice" placeholder="Ø§Ù„Ø§Ø³Ù… Ù‡Ù†Ø§..." oninput="syncSigs(this, 2)"></div>
                            <div class="sig-col">Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ø¯Ø±Ø³Ø©<br><input type="text" class="sig-input" id="sigManager" placeholder="Ø§Ù„Ø§Ø³Ù… Ù‡Ù†Ø§..." oninput="syncSigs(this, 3)"></div>
                        </div>
                    </div>
                </td>
            </tr>
        </tbody>
    </table>

</div>

<div class="user-credit">ØªÙ… Ø§Ù„ØªØ·ÙˆÙŠØ± Ø¨ÙˆØ§Ø³Ø·Ø© Ø£. Ø¹Ø¨Ø¯Ø§Ù„Ø±Ø­Ù…Ù† Ø³Ø¹Ø¯ Ø§Ù„Ø­Ø¬ÙŠÙ„ÙŠ</div>

<script>
    // === Ø§Ù„Ø¯ÙˆØ§Ù„ Ø§Ù„Ø¨Ø±Ù…Ø¬ÙŠØ© ===
    const origHeader = document.querySelector('.header-table').outerHTML;
    document.getElementById('plansHeaderCopy').innerHTML = origHeader;

    function updateHeaderCopy() {
        const currentHeader = document.querySelector('#analysisContent .header-table').outerHTML;
        document.getElementById('plansHeaderCopy').innerHTML = currentHeader;
        const origSelects = document.querySelector('#analysisContent .header-table').querySelectorAll('select');
        const copySelects = document.getElementById('plansHeaderCopy').querySelectorAll('select');
        origSelects.forEach((sel, i) => { if(copySelects[i]) copySelects[i].value = sel.value; });
    }

    const strategies = {
        remedial: ["ØªØ®ØµÙŠØµ Ø­ØµØµ Ø¥Ø¶Ø§ÙÙŠØ©", "Ø£ÙˆØ±Ø§Ù‚ Ø¹Ù…Ù„ Ù…Ø¨Ø³Ø·Ø©", "ØªØ¹Ù„Ù… Ø§Ù„Ø£Ù‚Ø±Ø§Ù†", "Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹ ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±", "Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±", "ØªØ¬Ø²Ø¦Ø© Ø§Ù„Ù…Ù‡Ø§Ù…", "Ø§Ù„ØªØ±ÙƒÙŠØ² Ø¹Ù„Ù‰ Ø§Ù„Ù…Ù‡Ø§Ø±Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©"],
        average: ["Ø·Ø±Ø­ Ø£Ø³Ø¦Ù„Ø© Ù…ØªØ¯Ø±Ø¬Ø©", "Ø§Ù„ØªØ¹Ù„Ù… Ø§Ù„ØªØ¹Ø§ÙˆÙ†ÙŠ", "ØªÙƒÙ„ÙŠÙ Ø¨Ù…Ù‡Ø§Ù… Ù‚ÙŠØ§Ø¯ÙŠØ©", "Ø§Ù„ØªØ¹Ø²ÙŠØ² Ø§Ù„Ø¥ÙŠØ¬Ø§Ø¨ÙŠ", "Ø§Ù„ØªØºØ°ÙŠØ© Ø§Ù„Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø¯Ù‚ÙŠÙ‚Ø©", "ÙˆØ§Ø¬Ø¨Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© Ù„Ù„ØªØ­Ø³ÙŠÙ†"],
        enrichment: ["Ù…Ù‡Ø§Ø±Ø§Øª Ø§Ù„ØªÙÙƒÙŠØ± Ø§Ù„Ø¹Ù„ÙŠØ§", "Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ© Ø§Ù„Ù…Ø¹Ù„Ù… Ø§Ù„ØµØºÙŠØ±", "Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ© ÙÙŠ Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø§Øª", "Ù…Ø´Ø§Ø±ÙŠØ¹ Ø¨Ø­Ø«ÙŠØ©", "Ù…ØµØ§Ø¯Ø± ØªØ¹Ù„Ù… Ø®Ø§Ø±Ø¬ÙŠØ©", "Ø­Ù„ Ù…Ø³Ø§Ø¦Ù„ Ù…ÙØªÙˆØ­Ø©"]
    };

    const toAr = (n) => String(n).replace(/\d/g, d => "Ù Ù¡Ù¢Ù£Ù¤Ù¥Ù¦Ù§Ù¨Ù©"[d]);
    let students = [];
    let charts = {};

    const yearSelect = document.getElementById('yearSelect');
    for(let y=1447; y<=1466; y++) {
        let opt = document.createElement('option'); opt.value = toAr(y) + ' Ù‡Ù€'; opt.text = toAr(y) + ' Ù‡Ù€'; yearSelect.add(opt);
    }

    function populateStrategies() {
        const fill = (id, list) => {
            const sel = document.getElementById(id);
            list.forEach(i => sel.add(new Option(i, i)));
            sel.add(new Option("âœï¸ ÙƒØªØ§Ø¨Ø© ÙŠØ¯ÙˆÙŠØ©...", "manual"));
        };
        fill('selRemedial', strategies.remedial);
        fill('selAverage', strategies.average);
        fill('selEnrichment', strategies.enrichment);
        document.getElementById('txtRemedial').value = strategies.remedial.slice(0, 2).join(" - ");
        document.getElementById('txtAverage').value = strategies.average.slice(0, 2).join(" - ");
        document.getElementById('txtEnrichment').value = strategies.enrichment.slice(0, 2).join(" - ");
    }
    populateStrategies();

    function toggleLayout(mode) {
        const container = document.getElementById('capture');
        container.classList.remove('mode-separate', 'mode-merged');
        container.classList.add('mode-' + mode);
        if (mode === 'separate') { updateHeaderCopy(); }
    }

    function syncSigs(source, index) {
        const upperSigs = document.querySelectorAll('.signature-analysis .sig-input');
        if(upperSigs[index]) upperSigs[index].value = source.value;
    }

    function appendStrategy(type, value) {
        if (!value) return;
        let txtBox = document.getElementById(type === 'rem' ? 'txtRemedial' : (type === 'avg' ? 'txtAverage' : 'txtEnrichment'));
        if (value === "manual") txtBox.focus();
        else if (txtBox.value.indexOf(value) === -1) txtBox.value += (txtBox.value ? " - " : "") + value;
        event.target.selectedIndex = 0;
    }

    function toggleManual(sel, id) { 
        document.getElementById(id).style.display = sel.value==='custom'?'block':'none'; 
        updateAll(); 
    }

    function getInputValue(selectId, manualId) {
        const sel = document.getElementById(selectId);
        return sel.value === 'custom' ? document.getElementById(manualId).value : sel.value;
    }

    document.getElementById('excelFile').onchange = (e) => {
        const reader = new FileReader();
        reader.onload = (ev) => {
            const wb = XLSX.read(ev.target.result, {type:'binary'});
            const data = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], {header:1});
            students = data.filter(r => r[0] && !isNaN(r[1])).map(r => ({name:r[0], grade:parseFloat(r[1])}));
            updateAll();
        };
        reader.readAsBinaryString(e.target.files[0]);
    };

    function addManual() {
        const n = document.getElementById('manualName').value;
        const g = parseFloat(document.getElementById('manualGrade').value);
        if(n && !isNaN(g)) { students.push({name:n, grade:g}); updateAll(); document.getElementById('manualName').value=''; document.getElementById('manualGrade').value=''; }
    }

    function removeStudent(index) { students.splice(index, 1); updateAll(); }

    function updateAll() {
        const max = parseFloat(document.getElementById('maxGrade').value) || 20;
        const totalFasl = parseInt(document.getElementById('totalInClass').value) || 0;
        const examName = getInputValue('examType', 'mExam');
        const subName = getInputValue('subject', 'mSub');
        const className = getInputValue('classGrade', 'mClass');

        document.getElementById('reportTitle').innerText = `ØªØ­Ù„ÙŠÙ„ Ø¯Ø±Ø¬Ø§Øª ${examName} Ù„Ù…Ø§Ø¯Ø© ${subName} Ù„Ù„ØµÙ ${className}`;
        document.getElementById('dispSub').innerText = subName;
        document.getElementById('autoPlanTitle').value = `Ø§Ù„Ø®Ø·Ø· Ø§Ù„Ø¹Ù„Ø§Ø¬ÙŠØ© ÙˆØ§Ù„Ø¥Ø«Ø±Ø§Ø¦ÙŠØ© ÙˆØ§Ù„ØªØ­Ø³ÙŠÙ†ÙŠØ© Ù„Ù€ ${examName} - ${subName} - ${className}`;

        const tbody = document.getElementById('dataTable'); tbody.innerHTML = '';
        let sum = 0, grades = [];
        let rList = [], aList = [], eList = [];

        students.forEach((s, i) => {
            const p = (s.grade/max)*100; sum += s.grade; grades.push(s.grade);
            if (p < 60) rList.push(s.name); else if (p >= 90) eList.push(s.name); else aList.push(s.name);
            tbody.innerHTML += `<tr><td>${toAr(i+1)}</td><td class="text-end px-2">${s.name}</td><td>${toAr(s.grade)}</td><td>${getT(p)}</td><td class="delete-col no-print"><button class="btn-delete" onclick="removeStudent(${i})">&times;</button></td></tr>`;
        });

        document.getElementById('remedialNames').innerText = rList.length ? rList.join('ØŒ ') : 'Ù„Ø§ ÙŠÙˆØ¬Ø¯';
        document.getElementById('averageNames').innerText = aList.length ? aList.join('ØŒ ') : 'Ù„Ø§ ÙŠÙˆØ¬Ø¯';
        document.getElementById('enrichmentNames').innerText = eList.length ? eList.join('ØŒ ') : 'Ù„Ø§ ÙŠÙˆØ¬Ø¯';
        document.getElementById('stTotal').innerText = toAr(totalFasl);
        document.getElementById('stPresent').innerText = toAr(students.length);
        document.getElementById('stAbsent').innerText = toAr(Math.max(0, totalFasl - students.length));
        
        if(students.length > 0) {
            const avg = sum/students.length;
            const std = Math.sqrt(grades.map(x => Math.pow(x - avg, 2)).reduce((a, b) => a + b) / students.length);
            document.getElementById('avgVal').innerText = toAr(avg.toFixed(2));
            document.getElementById('passRate').innerText = toAr(((grades.filter(g=>g>=max*0.5).length/students.length)*100).toFixed(1)) + '%';
            renderCharts(grades, max, avg, std);
        }
        if (document.querySelector('.mode-separate')) { updateHeaderCopy(); }
    }

    function getT(p) { if(p>=90) return 'Ù…Ù…ØªØ§Ø²'; if(p>=80) return 'Ø¬ÙŠØ¯ Ø¬Ø¯Ø§Ù‹'; if(p>=70) return 'Ø¬ÙŠØ¯'; if(p>=60) return 'Ù…Ù‚Ø¨ÙˆÙ„'; return 'Ø¶Ø¹ÙŠÙ'; }

    function renderCharts(grades, max, avg, std) {
        if(charts.p) charts.p.destroy(); if(charts.b) charts.b.destroy(); if(charts.n) charts.n.destroy();
        const cfg = { responsive: true, maintainAspectRatio: false, animation: false }; 
        charts.p = new Chart(document.getElementById('pieChart'), { type:'pie', data:{ labels:['Ù†Ø§Ø¬Ø­','Ø±Ø§Ø³Ø¨'], datasets:[{data:[grades.filter(g=>g>=max*0.5).length, grades.filter(g=>g<max*0.5).length], backgroundColor:['#198754','#dc3545']}] }, options: {...cfg, plugins:{title:{display:true,text:'Ù†Ø³Ø¨Ø© Ø§Ù„Ù†Ø¬Ø§Ø­'}}} });
        const dist = [0,0,0,0,0]; grades.forEach(g => { const p=(g/max)*100; if(p>=90) dist[0]++; else if(p>=80) dist[1]++; else if(p>=70) dist[2]++; else if(p>=60) dist[3]++; else dist[4]++; });
        charts.b = new Chart(document.getElementById('barChart'), { type:'bar', data:{ labels:['Ù…Ù…ØªØ§Ø²','Ø¬.Ø¬Ø¯Ø§','Ø¬ÙŠØ¯','Ù…Ù‚Ø¨ÙˆÙ„','Ø¶Ø¹ÙŠÙ'], datasets:[{label:'Ø§Ù„Ø·Ù„Ø§Ø¨', data:dist, backgroundColor:'#0d6efd'}] }, options: cfg });
        const xV = []; const yV = []; for(let x=0; x<=max; x+=max/20) { xV.push(x.toFixed(1)); yV.push((1/(std*Math.sqrt(2*Math.PI))) * Math.exp(-0.5*Math.pow((x-avg)/std,2))); }
        charts.n = new Chart(document.getElementById('normalChart'), { type:'line', data:{ labels:xV, datasets:[{label:'Ø§Ù„Ù…Ù†Ø­Ù†Ù‰', data:yV, borderColor:'#fd7e14', fill:true, backgroundColor:'rgba(253,126,20,0.1)'}] }, options:{...cfg, plugins:{legend:{display:false},title:{display:true,text:'Ø§Ù„Ù…Ù†Ø­Ù†Ù‰ Ø§Ù„Ø·Ø¨ÙŠØ¹ÙŠ'}}, scales:{x:{display:false},y:{display:false}}}});
    }

    function exportToPDF() {
        const elem = document.getElementById('capture');
        const opt = { margin: 0, filename: 'ØªØ­Ù„ÙŠÙ„_Ø§Ù„Ù†ØªØ§Ø¦Ø¬.pdf', image: { type: 'jpeg', quality: 1.0 }, html2canvas: { scale: 2, useCORS: true }, jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' } };
        html2pdf().set(opt).from(elem).save();
    }
    
    document.getElementById('mExam').addEventListener('input', updateAll);
    document.getElementById('mSub').addEventListener('input', updateAll);
    document.getElementById('mClass').addEventListener('input', updateAll);

    updateAll();
</script>
</body>
</html>
